<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clinical Note</title>
  <style>
    :root{--gap:12px;--bd:#e5e5e5;--txt:#111;--muted:#666}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:var(--txt)}
    header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--bd);padding:10px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{font-size:18px;margin:0;font-weight:600}
    .toolbar{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap;align-items:center}
    .toolbar label{font-size:12px;color:#444;display:flex;gap:6px;align-items:center}
    .toolbar select,.toolbar button,.toolbar input[type="checkbox"]{font-size:14px}
    .toolbar button{padding:7px 12px;border-radius:8px;border:1px solid #ccc;background:#fafafa;cursor:pointer}
    .toolbar button.primary{background:#111;color:#fff;border-color:#111}
    main{padding:16px;max-width:1100px;margin:0 auto}
    .section{margin:16px 0;border:1px solid #eee;border-radius:10px;padding:12px}
    .section h3{margin:0 0 8px;font-size:14px}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap);margin-bottom:8px}
    label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
    input,textarea,select{width:100%;padding:8px;border:1px solid #d0d0d0;border-radius:6px;font-size:14px}
    textarea{min-height:96px;line-height:1.35;resize:vertical}
    details summary{list-style:none;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px}
    details summary::-webkit-details-marker{display:none}
    details>summary::before{content:'\25B8';display:inline-block;width:1em}
    details[open]>summary::before{content:'\25BE'}
    .hint{font-size:12px;color:#777}
    #generatedNote{min-height:350px;white-space:pre-wrap}
    .statusbar{font-size:12px;color:var(--muted);display:flex;gap:12px;align-items:center;margin:6px 0 0}
    @media (max-width:760px){.toolbar{width:100%}}
  </style>
</head>
<body>
  <header>
    <h1>Clinical Note</h1>
    <div class="toolbar">
      <button id="signNote" class="btn">Sign Note</button>
      <label>Type
        <select id="noteType">
          <option value="soap">SOAP</option>
          <option value="birp">BIRP</option>
        </select>
      </label>
      <label>Specialty
        <select id="specialty"></select>
      </label>
      <label>Model
        <select id="llmModel"></select>
      </label>
      <label>Assist
        <select id="assistLevel">
          <option value="0">0 — Off</option>
          <option value="1">1 — Brief A</option>
          <option value="2">2 — Brief A+P</option>
          <option value="3">3 — Full A + Brief P</option>
          <option value="4">4 — Full A + Full P</option>
          <option value="5">5 — Full A, No Plan</option>
        </select>
      </label>
      <label><input id="redact" type="checkbox"/> Redact</label>
      <button id="clearPatient">Clear Patient Data</button>
      <button id="generateNote">Generate Note</button>
      <button id="exportPdf" class="primary">Export PDF</button>
    </div>
  </header>

  <main>
    <div class="section">
      <h3>Patient</h3>
      <div class="row">
        <div><label for="patient">Name</label><input id="patient" type="text"/></div>
        <div><label for="dob">DOB</label><input id="dob" type="date"/></div>
        <div><label for="sex">Sex</label><select id="sex"><option value=""></option><option>F</option><option>M</option><option>X</option></select></div>
        <div><label for="mrn">MRN</label><input id="mrn" type="text"/></div>
      </div>
    </div>

    <div class="section">
      <details id="telehealthDetails" open>
        <summary>Telehealth</summary>
        <div class="row">
          <div><label for="telePlatform">Platform</label><input id="telePlatform" type="text"/></div>
          <div><label for="teleModality">Modality</label><select id="teleModality"><option value=""></option><option value="video">Video</option><option value="audio">Audio-only</option></select></div>
          <div><label for="telePatientLocation">Patient location</label><input id="telePatientLocation" type="text"/></div>
          <div>
            <label for="teleConsentAt">Consent time</label>
            <input id="teleConsentAt" type="datetime-local"/>
            <div class="statusbar"><label style="display:flex;gap:6px;align-items:center"><input id="teleConsent" type="checkbox"/> Consent obtained</label></div>
          </div>
        </div>
      </details>
    </div>

    <div class="section soap-sec" id="sec-histories">
      <details open>
        <summary>Subjective</summary>
        <div class="row">
          <div style="grid-column:1/-1"><label for="chiefComplaint">Chief Complaint</label><textarea id="chiefComplaint"></textarea></div>
          <div style="grid-column:1/-1"><label for="hpi">History of Present Illness (HPI)</label><textarea id="hpi"></textarea></div>
          <div><label for="pmh">Past Medical History</label><textarea id="pmh"></textarea></div>
          <div><label for="psh">Past Surgical History</label><textarea id="psh"></textarea></div>
          <div><label for="familyHistory">Family History</label><textarea id="familyHistory"></textarea></div>
          <div><label for="socialHistory">Social History</label><textarea id="socialHistory"></textarea></div>
          <div><label for="allergies">Allergies</label><textarea id="allergies"></textarea></div>
          <div style="grid-column:1/-1"><label for="ros">Review of Systems</label><textarea id="ros"></textarea></div>
        </div>
      </details>
    </div>

    <div class="section soap-sec" id="sec-diagnostics">
      <details>
        <summary>Objective</summary>
        <div class="row">
          <div style="grid-column:1/-1"><label for="physicalExam">Physical Exam</label><textarea id="physicalExam"></textarea></div>
          <div><label for="bp">BP</label><input id="bp" type="text"/></div>
          <div><label for="hr">HR (bpm)</label><input id="hr" type="number" inputmode="numeric"/></div>
          <div><label for="temp">Temp (°F)</label><input id="temp" type="number" step="0.1" inputmode="decimal"/></div>
          <div><label for="rr">RR</label><input id="rr" type="number" inputmode="numeric"/></div>
          <div><label for="spo2">SpO₂ (%)</label><input id="spo2" type="number" step="1" inputmode="numeric"/></div>
          <div><label for="height">Height (in)</label><input id="height" type="number" step="1" inputmode="numeric"/></div>
          <div><label for="weight">Weight (lb)</label><input id="weight" type="number" step="0.1" inputmode="decimal"/></div>
          <div style="grid-column:1/-1"><label for="labs">Imaging / Labs</label><textarea id="labs"></textarea></div>
        </div>
      </details>
    </div>

    <div class="section soap-sec" id="sec-meds">
      <details>
        <summary>Medications</summary>
        <div class="row"><div><label for="medications">Medications</label><textarea id="medications"></textarea></div></div>
      </details>
    </div>

    <div class="section">
      <h3>Generated Note</h3>
      <textarea id="generatedNote" spellcheck="false" style="min-height:350px;white-space:pre-wrap"></textarea>
    </div>

    <div class="section soap-sec" id="sec-icd-suggest">
      <h3>ICD-10 Codes</h3>
      <div class="row">
        <div><label for="icdSearch">Search ICD-10</label><input id="icdSearch" type="text"/></div>
    
      </div>
      <div id="icd-box" style="min-height:120px;white-space:pre-wrap; border:1px solid #d0d0d0; border-radius:6px; padding:6px; overflow-y:auto;"></div>
    </div>

    <div class="section" id="sec-birp" style="display:none">
      <details open>
        <summary>BIRP</summary>
        <div class="row" style="grid-template-columns:1fr;">
          <div><label for="birpBehavior">Behavior</label><textarea id="birpBehavior"></textarea></div>
          <div><label for="birpIntervention">Intervention</label><textarea id="birpIntervention"></textarea></div>
          <div><label for="birpResponse">Response</label><textarea id="birpResponse"></textarea></div>
          <div><label for="birpPlan">Plan</label><textarea id="birpPlan"></textarea></div>
        </div>
      </details>
    </div>

    <div class="section" id="sec-clinician">
      <h3>Clinician</h3>
      <div id="clinicianBody">
        <div class="row">
          <div><label for="provider">Provider</label><input id="provider" type="text"/></div>
          <div>
            <label for="credentials">Credentials</label>
            <select id="credentials">
              <option value=""></option>
              <option>MD</option><option>DO</option><option>NP</option><option>PA</option>
              <option>RN</option><option>LPN</option><option>DNP</option><option>PharmD</option>
              <option>PhD</option><option>PsyD</option><option>LCSW</option><option>LMFT</option>
              <option>LPC</option><option>DPT</option><option>OTR/L</option><option>SLP</option>
            </select>
          </div>
          <div><label for="npi">NPI</label><input id="npi" type="text" inputmode="numeric"/></div>
          <div><label for="clinic">Clinic / Org</label><input id="clinic" type="text"/></div>
        </div>
        <div class="row"><div><label for="providerLocation">Provider location</label><input id="providerLocation" type="text"/></div></div>
        <div class="hint">Clinician and settings persist across reloads.</div>
      </div>
    </div>
     <div class="hint">Clinician and settings persist across reloads.</div>
  </div>
</div>

    <!-- Hidden fields for signature metadata -->
    <input type="hidden" id="signatureId" />
    <input type="hidden" id="signedAt" />
  </main>

  <script>
    (function(){
      function updateStatus(){
        var el=document.getElementById('assistLevel');
        var out=document.getElementById('assistStatus');
        if(!out)return;
        if(!el){out.textContent='Assist: 0 — Off';return}
        var map={'0':'Off','1':'Brief A','2':'Brief A+P','3':'Full A + Brief P','4':'Full A + Full P','5':'Full A, No Plan'};
        out.textContent='Assist: '+(el.value||'0')+' — '+(map[el.value]||'Off');
      }
      function applyNoteType(){
        var t=document.getElementById('noteType')?document.getElementById('noteType').value:'soap'
        var soapBlocks=document.querySelectorAll('.soap-sec')
        var birp=document.getElementById('sec-birp')
        soapBlocks.forEach(function(n){n.style.display=(t==='soap'?'':'none')})
        if(birp)birp.style.display=(t==='birp'?'':'none')
      }
      document.addEventListener('change',function(e){
        if(e.target&&e.target.id==='assistLevel')updateStatus()
        if(e.target&&e.target.id==='noteType')applyNoteType()
      })
      document.addEventListener('DOMContentLoaded',function(){updateStatus();applyNoteType()})
    })();
  </script>
  <script src="./persist-ui.js?v=13"></script>
  <script src="./icd-suggest.js?v=5"></script>
  <script src="./actions-stable.js?v=12.4"></script>
  <script src="./datetime-now.js"></script>
  <script defer src="/birp-actions.js"></script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const noteTypeSel = document.getElementById("noteType");
  const assistSel = document.getElementById("assistLevel");

  const soapOptions = [
    { value: "0", text: "0 — Off" },
    { value: "1", text: "1 — Brief A" },
    { value: "2", text: "2 — Brief A+P" },
    { value: "3", text: "3 — Full A + Brief P" },
    { value: "4", text: "4 — Full A + Full P" },
    { value: "5", text: "5 — Full A, No Plan" },
  ];

  const birpOptions = [
    { value: "0", text: "0 — Off" },
    { value: "1", text: "1 — Brief rewrite (~1 sentence each)" },
    { value: "2", text: "2 — Concise rewrite (1–2 sentences each)" },
    { value: "3", text: "3 — Expanded rewrite (2–4 sentences each)" },
    { value: "4", text: "4 — Full clinical draft (short paragraphs)" },
    { value: "5", text: "5 — Comprehensive draft (detailed phrasing)" },
  ];

  function updateAssistOptions() {
    const type = noteTypeSel.value;
    const options = type === "birp" ? birpOptions : soapOptions;

    // preserve currently selected value if it exists in new set
    const current = assistSel.value;

    assistSel.innerHTML = "";
    options.forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.text;
      assistSel.appendChild(o);
    });

    // restore selection if possible, otherwise default to 0
    if ([...assistSel.options].some(o => o.value === current)) {
      assistSel.value = current;
    } else {
      assistSel.value = "0";
    }
  }

  noteTypeSel.addEventListener("change", updateAssistOptions);
  updateAssistOptions(); // run once on load
});
</script>
 <script src="/session-config.js"></script>
<script>
(function() {
  // Pull value from server via env injection or hardcode
  const idleMinutes = window.__SESSION_IDLE_MINUTES__ || 30; 
  const idleMs = idleMinutes * 60 * 1000; 

  let idleTimer;

  function resetIdleTimer() {
    clearTimeout(idleTimer);
    idleTimer = setTimeout(() => {
      console.log("Idle timeout reached — logging out.");
      window.location.href = "/logout"; // force server logout + redirect to Google
    }, idleMs);
  }

  // Reset timer on activity
  ["mousemove","keydown","mousedown","touchstart"].forEach(evt => {
    document.addEventListener(evt, resetIdleTimer, { passive: true });
  });

  // Start on load
  resetIdleTimer();
})();
</script>
</body>
</html>